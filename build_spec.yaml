version: 0.1
component: build

env:
  vaultVariables:
    github_secret : ocid1.vaultsecret.oc1.sa-saopaulo-1.amaaaaaanfeltwyaot7h4tpsamfr2p7r4xilmanw2penqdgdoh63m272m6dq

steps:
  - type: Command
    name: "Login Github"
    failImmediatelyOnError: true
    command: echo "//npm.pkg.github.com/:_authToken=${github_secret}\n@jailtoncruz:registry=https://npm.pkg.github.com/" > ~/.npmrc

  - type: Command
    name: "Inspect file npmrc"
    failImmediatelyOnError: true
    command: cat ~/.npmrc

  - type: Command
    name: "Install dependencies"
    failImmediatelyOnError: true
    command: cd api && npm install

  - type: Command
    name: "Run test suits"
    failImmediatelyOnError: true
    command: npm run test

  - type: Command
    name: "Generate NestJS build"
    failImmediatelyOnError: true
    command: npm run build

  - type: Command
    name: "Build docker image"
    failImmediatelyOnError: true
    command: docker build -t sa-saopaulo-1.ocir.io/grbcvhus1oua/portfolio/api .

outputArtifacts:
  - name: api-docker-image
    type: DOCKER_IMAGE
    location: sa-saopaulo-1.ocir.io/grbcvhus1oua/portfolio/api